---
import { getCollection } from 'astro:content';
import BaseLayout from '@layouts/BaseLayout.astro';
import PostCard from '@components/PostCard.astro';

const categoryMeta: Record<string, { label: string; description: string; icon: string }> = {
  facial: {
    label: 'Facial Procedures',
    description: 'Expert guidance on rhinoplasty, facelifts, blepharoplasty, and facial rejuvenation. Board-certified insights to help you make confident decisions about facial aesthetic surgery.',
    icon: 'M15.182 15.182a4.5 4.5 0 01-6.364 0M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75zm-.375 0h.008v.015h-.008V9.75zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75zm-.375 0h.008v.015h-.008V9.75z',
  },
  body: {
    label: 'Body Contouring',
    description: 'Comprehensive guides on liposuction, tummy tucks, body lifts, and contouring procedures. Evidence-based information from experienced plastic surgeons.',
    icon: 'M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z',
  },
  breast: {
    label: 'Breast Surgery',
    description: 'In-depth articles on breast augmentation, reduction, lifts, and revision surgery. Trusted information to guide your breast surgery journey.',
    icon: 'M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z',
  },
  'non-surgical': {
    label: 'Non-Surgical',
    description: 'Explore the latest in injectables, laser treatments, chemical peels, and skin rejuvenation. Minimally invasive options explained by medical professionals.',
    icon: 'M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z',
  },
  recovery: {
    label: 'Recovery & Aftercare',
    description: 'Healing timelines, pain management, aftercare tips, and recovery guides. Everything you need to know for a smooth post-surgical journey.',
    icon: 'M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z',
  },
  news: {
    label: 'News & Updates',
    description: 'Stay current with the latest developments in aesthetic surgery, industry trends, new techniques, and practice updates.',
    icon: 'M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 01-2.25 2.25M16.5 7.5V18a2.25 2.25 0 002.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 002.25 2.25h13.5M6 7.5h3v3H6V7.5z',
  },
};

const allCategories = ['facial', 'body', 'breast', 'non-surgical', 'recovery', 'news'];

export function getStaticPaths() {
  return [
    { params: { category: 'facial' } },
    { params: { category: 'body' } },
    { params: { category: 'breast' } },
    { params: { category: 'non-surgical' } },
    { params: { category: 'recovery' } },
    { params: { category: 'news' } },
  ];
}

const { category } = Astro.params;
const meta = categoryMeta[category!] || { label: category, description: '', icon: '' };

const posts = await getCollection('blog', ({ data }) => !data.draft && data.category === category);
const sortedPosts = posts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
const postCount = sortedPosts.length;
const POSTS_PER_PAGE = 6;
---

<BaseLayout title={`${meta.label} | Aesthetic Surgery Journal`} description={meta.description}>
  <!-- Category Header -->
  <section class="bg-ivory pb-6 pt-8 md:pb-10 md:pt-12">
    <div class="mx-auto max-w-7xl px-6 lg:px-10">
      <!-- Breadcrumb -->
      <nav class="animate-on-scroll mb-8" aria-label="Breadcrumb">
        <ol class="flex items-center gap-2 text-xs text-charcoal/40">
          <li>
            <a href="/" class="transition-colors hover:text-charcoal">Home</a>
          </li>
          <li aria-hidden="true">
            <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5"></path>
            </svg>
          </li>
          <li>
            <span class="text-charcoal/60">{meta.label}</span>
          </li>
        </ol>
      </nav>

      <div class="animate-on-scroll flex items-start gap-5">
        <div class="flex h-14 w-14 shrink-0 items-center justify-center rounded-2xl bg-soft-blush/50">
          <svg
            class="h-7 w-7 text-rose-gold-dark"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="1.5"
          >
            <path stroke-linecap="round" stroke-linejoin="round" d={meta.icon} />
          </svg>
        </div>
        <div>
          <h1 class="font-serif text-3xl font-medium text-charcoal md:text-4xl lg:text-5xl">
            {meta.label}
          </h1>
          <p class="mt-2 max-w-2xl text-base leading-relaxed text-charcoal/50">
            {meta.description}
          </p>
          <p class="mt-3 text-xs font-medium uppercase tracking-[0.15em] text-rose-gold">
            {postCount} {postCount === 1 ? 'article' : 'articles'}
          </p>
        </div>
      </div>

      <!-- Category Pills -->
      <div class="animate-on-scroll stagger-1 mt-8 flex flex-wrap gap-2">
        {allCategories.map((cat) => (
          <a
            href={`/blog/category/${cat}`}
            class:list={[
              'rounded-full px-4 py-2 text-xs font-medium tracking-wide transition-all duration-200',
              cat === category
                ? 'bg-gradient-to-br from-rose-gold to-rose-gold-dark text-white shadow-cta'
                : 'bg-white text-charcoal/60 shadow-card hover:-translate-y-0.5 hover:text-charcoal hover:shadow-card-hover',
            ]}
          >
            {categoryMeta[cat]?.label || cat}
          </a>
        ))}
      </div>
    </div>
  </section>

  <div class="h-px bg-gradient-to-r from-transparent via-warm-sand/60 to-transparent"></div>

  <!-- Posts Grid -->
  <section class="bg-white py-12 md:py-16">
    <div class="mx-auto max-w-7xl px-6 lg:px-10">
      {sortedPosts.length > 0 ? (
        <>
          <div id="posts-grid" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
            {sortedPosts.map((post, i) => (
              <div
                class:list={[
                  'post-item animate-on-scroll',
                  `stagger-${(i % 4) + 1}`,
                  i >= POSTS_PER_PAGE && 'is-hidden',
                ]}
                data-index={i}
              >
                <PostCard
                  title={post.data.title}
                  description={post.data.description}
                  date={post.data.date}
                  category={post.data.category}
                  slug={post.id}
                  coverImage={post.data.coverImage}
                />
              </div>
            ))}
          </div>

          {/* Loading sentinel & indicator */}
          {postCount > POSTS_PER_PAGE && (
            <div id="scroll-sentinel" class="mt-12 flex flex-col items-center gap-4">
              <div id="loading-indicator" class="flex items-center gap-3">
                <div class="loading-dots flex gap-1.5">
                  <span class="h-2 w-2 rounded-full bg-rose-gold/60"></span>
                  <span class="h-2 w-2 rounded-full bg-rose-gold/60"></span>
                  <span class="h-2 w-2 rounded-full bg-rose-gold/60"></span>
                </div>
                <span class="text-sm font-medium tracking-wide text-charcoal/40">Loading more articles</span>
              </div>
            </div>
          )}

          {/* End message */}
          <div
            id="end-message"
            class:list={[
              'mt-12 text-center',
              postCount > POSTS_PER_PAGE && 'hidden',
            ]}
          >
            <p class="text-sm text-charcoal/30">You&rsquo;ve reached the end</p>
            <div class="mx-auto mt-3 h-px w-16 bg-warm-sand/60"></div>
          </div>
        </>
      ) : (
        <div class="py-20 text-center">
          <div class="mx-auto mb-6 flex h-20 w-20 items-center justify-center rounded-full bg-warm-sand/30">
            <svg class="h-10 w-10 text-charcoal/20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
            </svg>
          </div>
          <h2 class="font-serif text-2xl font-medium text-charcoal">No articles yet</h2>
          <p class="mt-2 text-sm text-charcoal/50">We&rsquo;re working on content for this category. Check back soon.</p>
          <a
            href="/"
            class="mt-6 inline-flex items-center gap-2 text-sm font-medium text-rose-gold transition-colors hover:text-rose-gold-dark"
          >
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
            </svg>
            Browse all articles
          </a>
        </div>
      )}
    </div>
  </section>

  <!-- Back to Home -->
  <div class="border-t border-warm-sand/40 bg-ivory">
    <div class="mx-auto max-w-7xl px-6 py-10 lg:px-10">
      <a
        href="/"
        class="group inline-flex items-center gap-2 text-sm font-medium text-charcoal/50 transition-colors hover:text-charcoal"
      >
        <svg class="h-4 w-4 transition-transform duration-200 group-hover:-translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"></path>
        </svg>
        Back to all articles
      </a>
    </div>
  </div>
</BaseLayout>

<style>
  .post-item.is-hidden {
    display: none;
  }

  .post-item.reveal {
    display: block;
    animation: fadeUpIn 0.5s var(--ease-smooth) both;
  }

  @keyframes fadeUpIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .loading-dots span {
    animation: dotPulse 1.4s ease-in-out infinite;
  }
  .loading-dots span:nth-child(2) {
    animation-delay: 0.2s;
  }
  .loading-dots span:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes dotPulse {
    0%, 80%, 100% {
      opacity: 0.3;
      transform: scale(0.8);
    }
    40% {
      opacity: 1;
      transform: scale(1);
    }
  }
</style>

<script define:vars={{ POSTS_PER_PAGE, postCount }}>
  let visibleCount = Math.min(POSTS_PER_PAGE, postCount);
  const sentinel = document.getElementById('scroll-sentinel');
  const loadingIndicator = document.getElementById('loading-indicator');
  const endMessage = document.getElementById('end-message');

  function revealNextBatch() {
    if (visibleCount >= postCount) return;

    const items = document.querySelectorAll('.post-item.is-hidden');
    const batch = Array.from(items).slice(0, POSTS_PER_PAGE);

    batch.forEach((item, i) => {
      setTimeout(() => {
        item.classList.remove('is-hidden');
        item.classList.add('reveal');
        // Ensure scroll animation fires
        item.classList.add('is-visible');
      }, i * 80);
    });

    visibleCount += batch.length;

    if (visibleCount >= postCount) {
      // All posts revealed
      if (loadingIndicator) loadingIndicator.style.display = 'none';
      if (endMessage) endMessage.classList.remove('hidden');
      if (sentinel) sentinel.style.display = 'none';
    }
  }

  if (sentinel && postCount > POSTS_PER_PAGE) {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            // Small delay to simulate loading feel
            setTimeout(revealNextBatch, 300);
          }
        });
      },
      { threshold: 0, rootMargin: '0px 0px 200px 0px' }
    );

    observer.observe(sentinel);
  }
</script>
